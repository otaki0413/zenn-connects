---
title: "OAuthとGitHubログインの仕組みをざっくり理解する"
emoji: "🛡️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["oauth", "openid"]
published: false
---

これは「Happiness Chain Advent Calendar 2024」の 11 日目の記事です。
https://adventar.org/calendars/10341

## はじめに

現在、Django を使った Twitter クローンアプリを作成しており、その中で GitHub ログイン機能を実装する機会がありました。実装自体はできたものの、「**OAuth**」 と呼ばれる仕組みが何をしているのかよくわかりませんでした。そこで本記事では、OAuth の基本的な仕組みについて学んだ内容を紹介しようと思います。

:::message
専門的な解説ではないので、間違った表現をしている可能性があります。
OAuth に関して、詳しい内容を知りたい方は専門書やドキュメントを読むことを推奨します。
:::

## OAuth って何？

こちらの記事がとてもわかりやすいので、まずは一度読むことをおすすめします！

https://qiita.com/TakahikoKawasaki/items/e37caf50776e00e733be

**OAuth**（**=Open Authorization**）とは、アプリや Web サービスが、
**ユーザーのデータや機能に安全にアクセスできるようにする仕様**のことです。

OAuth で実現できることとして、以下のようなものが挙げられます。

- Google アカウントを使って、他のアプリケーションにログインする
- 外部サービスから X の API を通じて、特定ユーザーのプロフィールやポストを取得する
- Slack と連携して、ユーザーが指定したチャンネルに対して通知を送信する

ただし、OAuth はあくまで、「**認可（Authorization）**」を実現するプロトコルです。
似たような表現に「**認証（Authentication）**」があり、これらは混同されやすいですが、異なる概念なので注意してください。

## OAuth は『認可』のプロトコルである

- **認証（Authentication）**: ユーザーが誰であるかを確認すること
- **認可（Authorization）**: 他のサービスやアプリのデータや機能へのアクセスを許可すること

https://zenn.dev/tanaka_takeru/articles/aecd36a805886d

もし「**認証**」を取り扱う場合には **OpenID Connect** という OAuth の拡張仕様が使用されます。
本記事では触れませんが、OpenID Connect を使うことで、**ユーザーが誰であるかの確認** もできるため、OAuth と組み合わせて認証と認可を実現するケースがあります。
OpenID Connect に興味のある方は下記記事を読むと、理解が深まるかなと思います。

https://qiita.com/TakahikoKawasaki/items/498ca08bbfcc341691fe

## OAuth の仕組みについて

それでは OAuth の仕組みを具体的に見ていきましょう。

### OAuth の構成要素

OAuth は以下 4 つの要素で構成されています。
| 要素 | 説明 |
| -------------------------------- | --------------------------------------------- |
| **リソースオーナー（ユーザー）** | データを所有しているユーザー |
| **アプリ** | リソースオーナーが利用するアプリケーション |
| **認可サーバー** | ユーザーのアクセス許可を管理するサーバー |
| **リソースサーバー** | ユーザーデータを格納し、API を提供するサーバー |

また、もう一つ重要なキーワードとして「**アクセストークン**」もあります。
これは認可サーバーがアプリに対して発行するものであり、これを使ってリソースサーバ上の特定のリソースにアクセスします。**アプリがリソースに安全にアクセスするための一時的な鍵**とイメージすると分かりやすいかと思います。

### OAuth のフローについて

次に、OAuth の各構成要素がどのような役割を果たしているかを、実際のフローで見ていきます。
[OAuth のフローは複数あります](https://qiita.com/TakahikoKawasaki/items/200951e5b5929f840a1f#1-%E8%AA%8D%E5%8F%AF%E3%82%B3%E3%83%BC%E3%83%89%E3%83%95%E3%83%AD%E3%83%BC)が、今回は標準的なフローである「**認可コードフロー（Authorization Code Flow）**」を紹介します。

OAuth の認可コードフローは、以下の 4 ステップで行われます。

1. **アプリが認可リクエストを送信する**

   - ユーザーがアプリを使って外部リソースへアクセスするために、
     アプリは認可サーバーに対して、アクセス許可をもらうためのリクエストを送信します。

2. **ユーザーがアクセス許可を承認する**

   - 認可サーバーは、ユーザーに対してアプリへのアクセス許可を要求します。
     ユーザーがこれを承認すると、認可サーバーは「認証コード」をアプリに送信します。

3. **アプリがアクセストークンを取得する**

   - アプリは認証コードを使って、認可サーバーからアクセストークンを受け取ります。

4. **リソースサーバーへリクエストを送信する**
   - アプリはアクセストークンを使ってリソースサーバーに API リクエストを送信し、必要なデータを取得します。

上記フローを図示すると、以下のようになります。

```mermaid
sequenceDiagram
    participant User as ユーザー
    participant App as アプリ
    participant OServer as 認可サーバー
    participant RServer as リソースサーバー

    User->>App: ユーザーのリソースにアクセスしたい
    App->>OServer: 認可リクエストを送信
    OServer->>User: アプリへのアクセス許可を確認
    User->>OServer: アプリへのアクセス許可を承認
    OServer->>App: 認証コードを送信
    App->>OServer: 認証コードを使ってアクセストークンをリクエスト
    OServer->>OServer: アクセストークン生成
    OServer->>App: アクセストークン発行
    App->>RServer: APIリクエスト（アクセストークン添付）
    RServer->>RServer: アクセストークン検証
    RServer->>App: リクエストされたデータを返す

```

### GitHub ログインの場合は？

では GitHub ログインを例にして、OAuth フロー がどのように関係しているのかを見ていきます。
さきほど説明した OAuth の構成要素に

| 要素                             | GitHub ログインの場合               |
| -------------------------------- | ----------------------------------- |
| **リソースオーナー（ユーザー）** | GitHub アカウントを所有するユーザー |
| **アプリ**                       | Twitter クローンアプリ              |
| **認可サーバー**                 | GitHub のサーバー                   |
| **リソースサーバー**             | GitHub API                          |

ここで疑問に思う方がいるかもしれません。
「**そういえば OAuth って『認可』のプロトコルでは？ログインだと『認証』になるのでは？**」

GitHub ログインでは、GitHub が認可サーバーとリソースサーバーの両方を担っています。そのため、認可フローを通じてアクセストークンを取得するだけで、ユーザー情報（例: ユーザー名、メールアドレス）をリソースサーバーから直接取得できます。これにより、アプリ側で別途認証処理を追加せずにログインを完結できます。

```mermaid
sequenceDiagram
    participant User as ユーザー
    participant App as アプリ
    participant GitHub as GitHub

    User->>App: ①「GitHubでログイン」ボタンをクリック
    App->>GitHub: ②認可リクエストをエンドポイントに送信
    GitHub->>User: ③ログイン画面を表示
    User->>GitHub: ④ユーザー名/パスワードでログイン
    GitHub->>User: アプリへのアクセス許可を確認
    User->>GitHub: 許可を承認
    GitHub->>App: 認証コードを送信
    App->>GitHub: 認証コードを使用してアクセストークンをリクエスト
    GitHub->>App: アクセストークンを送信
    App->>GitHub: APIリクエストを送信（アクセストークン添付）
    GitHub->>App: リクエストされたデータを返す
    App->>App: 取得したGitHubのユーザー情報で認証・ログイン
```

## おわりに

本記事では、OAuth の仕組みの基本について、説明しました。
OAuth はすべてを理解しようとすると奥が深い技術ですが、全体像だけでも理解できれば、ソーシャル認証を実装する際に活かせる場面があると感じました。今後も
最後まで、読んでいただきありがとうございました！

## 参考サイト

https://qiita.com/TakahikoKawasaki/items/e37caf50776e00e733be
https://zenn.dev/takamin55/articles/538711ed6fd48d
